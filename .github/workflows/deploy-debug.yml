name: Deploy Debug

env:
    REGISTRY: ghcr.io
    IMAGE_NAME: ${{ github.repository }}

on: workflow_dispatch

jobs:
    deploy:
        runs-on: ubuntu-22.04

        steps:
            - name: Checkout
              uses: actions/checkout@v4.1.1
              env:
                  GIT_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  fetch-depth: 0

            - name: Install ssh keys
              run: |
                  install -m 600 -D /dev/null ~/.ssh/id_rsa
                  echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
                  ssh-keyscan -H ${{ secrets.SSH_HOST }} > ~/.ssh/known_hosts
                  docker context create remote --docker host=ssh://${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}

            - name: Extract metadata (tags, labels) for Docker
              id: meta
              uses: docker/metadata-action@9ec57ed1fcdbf14dcef7dfbe97b2010124a938b7
              with:
                  images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}

            - name: Log in to the Container registry
              uses: docker/login-action@v3.0.0
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Debug Deploy services
              env:
                  IMAGE_REF: ${{ steps.meta.outputs.tags }}
                  DATABASE_NAME: ${{ secrets.DATABASE_NAME }}
                  DATABASE_USER: ${{ secrets.DATABASE_USER }}
                  DATABASE_PASSWORD: ${{ secrets.DATABASE_PASSWORD }}
                  DATABASE_ROOT_PASSWORD: ${{ secrets.DATABASE_ROOT_PASSWORD }}
                  WORDPRESS_URL: ${{ secrets.WORDPRESS_URL }}
                  SCHEMA_URL: ${{ secrets.SCHEMA_URL }}
              run: |
                  echo "=== –ù–ê–ß–ê–õ–û –û–¢–õ–ê–î–û–ß–ù–û–ì–û –î–ï–ü–õ–û–Ø ==="

                  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –¥–æ –∑–∞–ø—É—Å–∫–∞
                  echo "–°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –¥–æ –∑–∞–ø—É—Å–∫–∞:"
                  docker --context remote compose -f docker-compose.prod.yml ps -a

                  # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∏ —É–¥–∞–ª—è–µ–º orphan –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
                  echo "–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
                  docker --context remote compose -f docker-compose.prod.yml down -v --remove-orphans

                  # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ database –∏ wordpress (frontend –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –ø–æ—Å–ª–µ wp-cli)
                  echo "–ó–∞–ø—É—Å–∫–∞–µ–º database, wordpress..."
                  docker --context remote compose -f docker-compose.prod.yml up -d database wordpress

                  # –ñ–¥–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
                  echo "–ñ–¥–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
                  timeout 60 bash -c 'until docker --context remote compose -f docker-compose.prod.yml exec -T database mysqladmin ping -h localhost --silent; do echo "Waiting for database..."; sleep 2; done'
                  echo "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≥–æ—Ç–æ–≤–∞!"

                  # –ñ–¥–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ WordPress
                  echo "–ñ–¥–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ WordPress..."
                  timeout 120 bash -c 'until docker --context remote compose -f docker-compose.prod.yml exec -T wordpress curl -f http://localhost:80 > /dev/null 2>&1; do echo "Waiting for WordPress..."; sleep 5; done'
                  echo "WordPress –≥–æ—Ç–æ–≤!"

                  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤ –ø–µ—Ä–µ–¥ wp-cli
                  echo "–°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º wp-cli:"
                  docker --context remote compose -f docker-compose.prod.yml ps

                  # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å WordPress
                  echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å WordPress:"
                  docker --context remote compose -f docker-compose.prod.yml exec -T wordpress curl -I http://localhost:80 || echo "WordPress –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"

                  # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª—ã WordPress
                  echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª—ã WordPress:"
                  docker --context remote compose -f docker-compose.prod.yml exec -T wordpress ls -la /var/www/html/ || echo "–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å ls –≤ wordpress"

                  echo "–ö–æ–ø–∏—Ä—É–µ–º —Ç–µ–º—É ragu –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä wordpress..."
                  tar -czf - -C wp-themes ragu | docker --context remote compose -f docker-compose.prod.yml exec -T wordpress sh -lc 'mkdir -p /var/www/html/wp-content/themes && tar -xzf - -C /var/www/html/wp-content/themes'
                  docker --context remote compose -f docker-compose.prod.yml exec -T wordpress ls -la /var/www/html/wp-content/themes/ragu || echo "–¢–µ–º–∞ ragu –Ω–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–ª–∞—Å—å"

                  # –ó–∞–ø—É—Å–∫–∞–µ–º wp-cli –ø–æ—à–∞–≥–æ–≤–æ
                  echo "=== –ó–ê–ü–£–°–ö WP-CLI –ü–û–®–ê–ì–û–í–û ==="

                  echo "–ó–∞–ø—É—Å–∫ –®–ê–ì 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤..."
                  docker --context remote compose -f docker-compose.prod.yml up --exit-code-from wp-cli-step1 wp-cli-step1
                  STEP1_EXIT_CODE=$?
                  if [ $STEP1_EXIT_CODE -ne 0 ]; then
                      echo "‚ùå –®–ê–ì 1 –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π (–∫–æ–¥: $STEP1_EXIT_CODE)!"
                      docker --context remote compose -f docker-compose.prod.yml logs wp-cli-step1
                      exit 1
                  fi
                  echo "‚úÖ –®–ê–ì 1 –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —É—Å–ø–µ—à–Ω–æ!"

                  echo "–ó–∞–ø—É—Å–∫ –®–ê–ì 2: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ WordPress..."
                  docker --context remote compose -f docker-compose.prod.yml up --exit-code-from wp-cli-step2 wp-cli-step2
                  STEP2_EXIT_CODE=$?
                  if [ $STEP2_EXIT_CODE -ne 0 ]; then
                      echo "‚ùå –®–ê–ì 2 –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π (–∫–æ–¥: $STEP2_EXIT_CODE)!"
                      echo "=== –î–ï–¢–ê–õ–¨–ù–´–ï –õ–û–ì–ò –®–ê–ì 2 ==="
                      docker --context remote compose -f docker-compose.prod.yml logs wp-cli-step2
                      echo "=== –õ–û–ì–ò WORDPRESS ==="
                      docker --context remote compose -f docker-compose.prod.yml logs wordpress
                      echo "=== –õ–û–ì–ò DATABASE ==="
                      docker --context remote compose -f docker-compose.prod.yml logs database
                      exit 1
                  fi
                  echo "‚úÖ –®–ê–ì 2 –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —É—Å–ø–µ—à–Ω–æ!"

                  echo "–ó–∞–ø—É—Å–∫ –®–ê–ì 3: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–∞–∑–æ–≤—ã—Ö –ø–ª–∞–≥–∏–Ω–æ–≤..."
                  docker --context remote compose -f docker-compose.prod.yml up --exit-code-from wp-cli-step3 wp-cli-step3
                  STEP3_EXIT_CODE=$?
                  if [ $STEP3_EXIT_CODE -ne 0 ]; then
                      echo "‚ùå –®–ê–ì 3 –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π (–∫–æ–¥: $STEP3_EXIT_CODE)!"
                      docker --context remote compose -f docker-compose.prod.yml logs wp-cli-step3
                      exit 1
                  fi
                  echo "‚úÖ –®–ê–ì 3 –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —É—Å–ø–µ—à–Ω–æ!"

                  echo "–ó–∞–ø—É—Å–∫ –®–ê–ì 4: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ wp-graphql-woocommerce..."
                  docker --context remote compose -f docker-compose.prod.yml up --exit-code-from wp-cli-step4 wp-cli-step4
                  STEP4_EXIT_CODE=$?
                  if [ $STEP4_EXIT_CODE -ne 0 ]; then
                      echo "‚ùå –®–ê–ì 4 –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π (–∫–æ–¥: $STEP4_EXIT_CODE)!"
                      docker --context remote compose -f docker-compose.prod.yml logs wp-cli-step4
                      exit 1
                  fi
                  echo "‚úÖ –®–ê–ì 4 –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —É—Å–ø–µ—à–Ω–æ!"

                  echo "–ó–∞–ø—É—Å–∫ –®–ê–ì 5: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —è–∑—ã–∫–æ–≤ –∏ —Ç–µ–º—ã..."
                  docker --context remote compose -f docker-compose.prod.yml up --exit-code-from wp-cli-step5 wp-cli-step5
                  STEP5_EXIT_CODE=$?
                  if [ $STEP5_EXIT_CODE -ne 0 ]; then
                      echo "‚ùå –®–ê–ì 5 –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π (–∫–æ–¥: $STEP5_EXIT_CODE)!"
                      docker --context remote compose -f docker-compose.prod.yml logs wp-cli-step5
                      exit 1
                  fi
                  echo "‚úÖ –®–ê–ì 5 –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —É—Å–ø–µ—à–Ω–æ!"

                  echo "–ó–∞–ø—É—Å–∫ –®–ê–ì 6: –§–∏–Ω–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞..."
                  docker --context remote compose -f docker-compose.prod.yml up --exit-code-from wp-cli-step6 wp-cli-step6
                  STEP6_EXIT_CODE=$?
                  if [ $STEP6_EXIT_CODE -ne 0 ]; then
                      echo "‚ùå –®–ê–ì 6 –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π (–∫–æ–¥: $STEP6_EXIT_CODE)!"
                      docker --context remote compose -f docker-compose.prod.yml logs wp-cli-step6
                      exit 1
                  fi
                  echo "‚úÖ –®–ê–ì 6 –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —É—Å–ø–µ—à–Ω–æ!"

                  echo "üéâ –í–°–ï –®–ê–ì–ò WP-CLI –ó–ê–í–ï–†–®–ï–ù–´ –£–°–ü–ï–®–ù–û!"

                  echo "–ó–∞–ø—É—Å–∫–∞–µ–º frontend..."
                  docker --context remote compose -f docker-compose.prod.yml up -d frontend

                  echo "–ñ–¥–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ frontend..."
                  timeout 60 bash -c 'until curl -f http://localhost:3000 > /dev/null 2>&1; do sleep 5; done'

                  echo "‚úÖ –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—â–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"
                  echo "WordPress: http://localhost:8080"
                  echo "Frontend: http://localhost:3000"

            - name: cleanup
              if: always()
              run: |
                  echo "–û—á–∏—Å—Ç–∫–∞..."
                  rm -rf ~/.ssh
